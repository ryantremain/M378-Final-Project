---
title: "Decision Tree Model"
format:
  html:
    code-fold: true
---

Now, we will be using R to create a simple decision tree model for the Palmer Penguins Dataset.

```{r}
library(dplyr)
library(ggplot2)
library(dbplyr)
library(tidyverse)
library(tidymodels)
library(rpart.plot)

con <- DBI::dbConnect(duckdb::duckdb(), dbdir = "my-db.duckdb")
df <- dplyr::tbl(con, "penguins_R")
```

```{r}
Penguins <- as_tibble(df)
Penguins <- drop_na(Penguins)
```

Now, we will split our data to create a training and test set.

```{r}
set.seed(1)
Penguins_split <- initial_split(Penguins, prop = 0.8)
Penguins_train <- training(Penguins_split)
Penguins_test <- testing(Penguins_split)
```

```{r}
tree_spec <- decision_tree() %>%   
  set_engine("rpart") %>%
  set_mode("regression")
```

```{r}
tree_fit <- tree_spec |>
  fit(body_mass_g ~ ., Penguins_train)
```

```{r}
#| warning: false 
tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot()
```

Now that we have a simple regression tree, we can evaluate it using RMSE.

```{r}
augment(tree_fit, new_data = Penguins_train) %>%   
  rmse(truth = body_mass_g, estimate = .pred)
```

```{r}
augment(tree_fit, new_data = Penguins_test) %>%   
  rmse(truth = body_mass_g, estimate = .pred)
```

As we can see, our simple model fits relatively well to our training data, but performs poorly on our test data. Our RMSE tells us that on average our decision tree's predictions deviate from actual penguin body masses by 378 grams. For future research, we can consider fitting a larger tree and tuning our tree's parameters to achieve a lower RMSE, or using ensemble methods. However, our simple tree is easy to interpret, and we can gather that, on average, Adelie and Chinstrap penguins are smaller than other species, and female penguins of a given species are lighter than their male counterparts.

```{r}
DBI::dbDisconnect(con)
```
